<script type="text/babel">

  const { useState } = React;

const SUPABASE_URL = "https://lsctlfavvxasbkcvbjmq.supabase.co";
const SUPABASE_KEY = "sb_publishable_33maxbMOQrHvDSYwFouYNQ_EWrP1s8K";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const cuisines = ["italian","mexican","asian","american","indian","mediterranean","healthy","other"];

const defaultMeals = {
  breakfast: { cuisine: "", where: "home", healthy: false, portion: false },
  lunch:     { cuisine: "", where: "home", healthy: false, portion: false },
  dinner:    { cuisine: "", where: "home", healthy: false, portion: false }
};

const defaultActivity = {
  cardio: "none",
  tennis: false,
  intensity: "M",
  rehab: false,
  stretch: false
};

const Toggle = ({ value, onChange }) => (
  <button
    onClick={() => onChange(!value)}
    className={`w-12 h-7 rounded-full transition ${value ? "bg-green-500" : "bg-gray-300"}`}
  >
    <span
      className={`block w-5 h-5 bg-white rounded-full transform transition ${
        value ? "translate-x-6" : "translate-x-1"
      }`}
    />
  </button>
);

const MealCard = ({ label, icon, data, onChange }) => {
  const [open, setOpen] = useState(false);

  const summary = [
    data.cuisine,
    data.where,
    data.healthy && "ü•ó",
    data.portion && "‚öñÔ∏è"
  ].filter(Boolean).join(" ¬∑ ");

  return (
    <div className="bg-white mx-4 mb-4 rounded-2xl shadow-sm overflow-hidden">
      <button
        onClick={() => setOpen(!open)}
        className="w-full p-4 flex justify-between items-center"
      >
        <span className="font-semibold text-lg flex items-center gap-2">
          {icon} {label}
        </span>
        <span className="text-sm text-gray-500">
          {summary || "Tap to log"}
        </span>
      </button>

      {open && (
        <div className="divide-y">
          <div className="p-4 flex justify-between">
            <span>Cuisine</span>
            <select
              className="text-[#007AFF]"
              value={data.cuisine}
              onChange={e => onChange("cuisine", e.target.value)}
            >
              <option value="">Select</option>
              {cuisines.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>

          <div className="p-4 flex justify-between">
            <span>Where</span>
            <div className="bg-gray-100 p-1 rounded-lg flex gap-1">
              {["home","out"].map(w => (
                <button
                  key={w}
                  onClick={() => onChange("where", w)}
                  className={`px-4 py-1 rounded-md ${
                    data.where === w ? "bg-white shadow" : "text-gray-500"
                  }`}
                >
                  {w}
                </button>
              ))}
            </div>
          </div>

          <div className="p-4 flex justify-between">
            <span>Healthy Choice</span>
            <Toggle value={data.healthy} onChange={v => onChange("healthy", v)} />
          </div>

          <div className="p-4 flex justify-between">
            <span>Portion Controlled</span>
            <Toggle value={data.portion} onChange={v => onChange("portion", v)} />
          </div>
        </div>
      )}
    </div>
  );
};

const App = () => {
  const [meals, setMeals] = useState(defaultMeals);
  const [activity, setActivity] = useState(defaultActivity);

  const updateMeal = (meal, field, value) => {
    setMeals(prev => ({ ...prev, [meal]: { ...prev[meal], [field]: value } }));
  };

  const hasData =
    Object.values(meals).some(m => m.cuisine || m.healthy || m.portion) ||
    activity.cardio !== "none" ||
    activity.tennis;

  const handleSubmit = async () => {
    const user = (await supabaseClient.auth.getUser()).data.user;
    if (!user) return alert("Not logged in");

    const payload = {
      user_id: user.id,
      log_date: new Date().toISOString().split("T")[0],
      meals,
      activity
    };

    const { error } = await supabaseClient
      .from("daily_logs")
      .upsert(payload, { onConflict: "user_id,log_date" });

    if (error) alert(error.message);
    else alert("‚úÖ Day logged!");
  };

  return (
    <div className="max-w-md mx-auto pb-16">
      <div className="px-5 pt-8 pb-4">
        <h1 className="text-3xl font-bold">Daily Habit Tracker</h1>
        <p className="text-gray-500">
          {new Date().toLocaleDateString(undefined, { weekday:"long", month:"long", day:"numeric" })}
        </p>
      </div>

      <h2 className="text-xs uppercase text-gray-500 ml-4 mb-2">Meals</h2>
      <MealCard label="Breakfast" icon="üç≥" data={meals.breakfast} onChange={(f,v)=>updateMeal("breakfast",f,v)} />
      <MealCard label="Lunch" icon="ü•ó" data={meals.lunch} onChange={(f,v)=>updateMeal("lunch",f,v)} />
      <MealCard label="Dinner" icon="üçΩÔ∏è" data={meals.dinner} onChange={(f,v)=>updateMeal("dinner",f,v)} />

      <h2 className="text-xs uppercase text-gray-500 ml-4 mb-2 mt-6">Activity</h2>
      <div className="bg-white mx-4 rounded-2xl divide-y shadow-sm">
        <div className="p-4 flex justify-between">
          <span>Cardio</span>
          <select
            className="text-[#007AFF]"
            value={activity.cardio}
            onChange={e => setActivity({...activity, cardio:e.target.value})}
          >
            <option value="none">None</option>
            <option value="run">Run</option>
            <option value="cycle">Cycle</option>
            <option value="swim">Swim</option>
          </select>
        </div>

        {["tennis","rehab","stretch"].map(k => (
          <div key={k} className="p-4 flex justify-between">
            <span>{k.charAt(0).toUpperCase()+k.slice(1)}</span>
            <Toggle value={activity[k]} onChange={v => setActivity({...activity, [k]:v})} />
          </div>
        ))}
      </div>

      <div className="p-4 mt-6">
        <button
          disabled={!hasData}
          onClick={handleSubmit}
          className={`w-full py-4 rounded-2xl font-semibold transition ${
            hasData ? "bg-[#007AFF] text-white" : "bg-gray-300 text-gray-500"
          }`}
        >
          Complete Day
        </button>
      </div>
    </div>
  );
};

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
