<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Habit Tracker</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">

<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

// --- SUPABASE ---
const SUPABASE_URL = "https://lsctlfavvxasbkcvbjmq.supabase.co";
const SUPABASE_KEY = "sb_publishable_33maxbMOQrHvDSYwFouYNQ_EWrP1s8K";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// --- DATA ---
const breakfastOptions = ["", "Eggs ++", "Muesli + Milk", "Protein Shake", "Others"];
const lunchDinnerOptions = ["", "Indian", "Thai", "Mexican", "Soup / Noodles", "Bengali", "Italian", "Others"];

const defaultMeals = {
  breakfast: { activeChoice: false, cuisine: "", portion: false, avoidedDessert: true },
  lunch:     { activeChoice: false, cuisine: "", portion: false, avoidedDessert: true },
  dinner:    { activeChoice: false, cuisine: "", portion: false, avoidedDessert: true }
};
const defaultActivity = { cardio: "none", tennis: false, rehab: false, stretch: false };
const defaultDay = { snack: false };

// --- MODERN iOS-STYLE TOGGLE ---
const Toggle = ({ value, onChange }) => (
  <button onClick={() => onChange(!value)} className="relative inline-flex items-center">
    <div className={`w-14 h-8 rounded-full transition duration-300 ${value ? "bg-blue-600" : "bg-gray-300"}`}>
      <div className={`w-7 h-7 bg-white rounded-full shadow-lg absolute top-0.5 transition duration-300 ${value ? "translate-x-6" : "translate-x-0.5"}`} />
    </div>
  </button>
);

// --- MEAL CARD (Modern Clean Design) ---
const MealCard = ({ label, icon, data, onChange, options }) => (
  <div className="bg-white rounded-3xl shadow-lg overflow-hidden">
    <div className="bg-gradient-to-br from-blue-50 to-indigo-100 px-8 py-10 text-center">
      <div className="text-7xl mb-4">{icon}</div>
      <h3 className="text-3xl font-bold text-gray-800">{label}</h3>
    </div>

    <div className="p-8 space-y-10">
      {/* Active Choice */}
      <div className="flex justify-between items-center">
        <span className="text-xl font-semibold text-gray-800">Active Choice</span>
        <Toggle value={data.activeChoice} onChange={v => onChange("activeChoice", v)} />
      </div>

      {/* Cuisine Dropdown */}
      <div>
        <select 
          value={data.cuisine} 
          onChange={e => onChange("cuisine", e.target.value)}
          className="w-full px-6 py-4 bg-gray-100 rounded-2xl text-xl font-medium text-gray-800 focus:outline-none focus:ring-4 focus:ring-blue-300 transition"
        >
          {options.map(opt => <option key={opt} value={opt}>{opt || "‚Äî"}</option>)}
        </select>
      </div>

      {/* Portion Controlled */}
      <div className="flex justify-between items-center">
        <span className="text-xl font-semibold text-gray-800">Portion Controlled</span>
        <Toggle value={data.portion} onChange={v => onChange("portion", v)} />
      </div>

      {/* Avoided Dessert */}
      <div className="flex justify-between items-center">
        <span className="text-xl font-semibold text-gray-800">Avoided Dessert</span>
        <Toggle value={data.avoidedDessert} onChange={v => onChange("avoidedDessert", v)} />
      </div>
    </div>
  </div>
);

// --- WELCOME PAGE ---
const WelcomePage = ({ logs, setPage }) => {
  const today = new Date();
  const thirtyDaysAgo = new Date(today);
  thirtyDaysAgo.setDate(today.getDate() - 30);

  const loggedSet = new Set(logs.filter(log => new Date(log.log_date) >= thirtyDaysAgo).map(log => log.log_date));

  let streak = 0;
  let checkDate = new Date(today);
  while (true) {
    const dateStr = checkDate.toISOString().split('T')[0];
    if (loggedSet.has(dateStr)) {
      streak++;
      checkDate.setDate(checkDate.getDate() - 1);
    } else break;
  }

  return (
    <button 
      onClick={() => setPage('log')} 
      className="h-screen w-full flex items-center justify-center bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50"
    >
      <div className="text-center px-10">
        <h1 className="text-5xl font-extrabold text-gray-900 mb-16">Daily Habit Tracker</h1>
        <div className="bg-white/90 backdrop-blur-lg rounded-3xl shadow-2xl p-16">
          <h3 className="text-3xl font-bold text-gray-700 mb-8">Current Streak</h3>
          <div className="text-9xl font-extrabold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-6">
            {streak}
          </div>
          <div className="text-3xl font-medium text-gray-600">days in a row üî•</div>
        </div>
        <p className="text-2xl text-gray-700 mt-16">Tap anywhere to log today</p>
      </div>
    </button>
  );
};

// --- LOG PAGE ---
const LogPage = ({ logs, setPage, refetchLogs }) => {
  const [meals, setMeals] = useState(defaultMeals);
  const [activity, setActivity] = useState(defaultActivity);
  const [snack, setSnack] = useState(false);

  const today = new Date().toISOString().split("T")[0];
  const todayLog = logs.find(l => l.log_date === today);

  useEffect(() => {
    if (todayLog) {
      setMeals(todayLog.meals || defaultMeals);
      setActivity(todayLog.activity || defaultActivity);
      setSnack(todayLog.snack || false);
    } else {
      setMeals(defaultMeals);
      setActivity(defaultActivity);
      setSnack(false);
    }
  }, [todayLog]);

  const updateMeal = (meal, field, value) => {
    setMeals(prev => ({...prev, [meal]: {...prev[meal], [field]: value}}));
  };

  const hasData = Object.values(meals).some(m => m.activeChoice || m.cuisine || !m.avoidedDessert || m.portion) ||
                  activity.cardio !== "none" || activity.tennis || activity.rehab || activity.stretch || snack;

  const handleSubmit = async () => {
    const payload = { user_id: "me", log_date: today, meals, activity, snack };
    const { error } = await supabase.from("daily_logs").upsert(payload, { onConflict: "user_id,log_date" });
    if (error) alert("Error: " + error.message);
    else {
      alert("‚úÖ Day logged!");
      refetchLogs();
      setPage('stats');
    }
  };

  const dateStr = new Date().toLocaleDateString(undefined, { weekday: "long", month: "long", day: "numeric", year: "numeric" });

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 pb-32">
      <div className="px-8 pt-16 pb-10 text-center">
        <h1 className="text-5xl font-extrabold text-gray-900">Today</h1>
        <p className="text-2xl text-gray-600 mt-3">{dateStr}</p>
      </div>

      <div className="px-6">
        <h2 className="text-3xl font-bold text-gray-800 mb-8 text-center">Meals</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16">
          <MealCard label="Breakfast" icon="üç≥" data={meals.breakfast} onChange={(f,v) => updateMeal("breakfast",f,v)} options={breakfastOptions} />
          <MealCard label="Lunch" icon="ü•ó" data={meals.lunch} onChange={(f,v) => updateMeal("lunch",f,v)} options={lunchDinnerOptions} />
          <MealCard label="Dinner" icon="üçΩÔ∏è" data={meals.dinner} onChange={(f,v) => updateMeal("dinner",f,v)} options={lunchDinnerOptions} />
        </div>

        {/* Snack */}
        <div className="bg-white rounded-3xl shadow-lg p-8 mb-16">
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-6">
              <div className="text-6xl">üçø</div>
              <h3 className="text-3xl font-bold text-gray-800">Had a Snack Today?</h3>
            </div>
            <Toggle value={snack} onChange={setSnack} />
          </div>
        </div>

        {/* Activity */}
        <h2 className="text-3xl font-bold text-gray-800 mb-8 text-center">Activity</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-10 max-w-5xl mx-auto">
          <div className="bg-white rounded-3xl shadow-lg p-10 space-y-12">
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-6">
                <div className="text-5xl">üèÉ</div>
                <span className="text-2xl font-semibold">Cardio</span>
              </div>
              <select 
                value={activity.cardio} 
                onChange={e=>setActivity({...activity,cardio:e.target.value})}
                className="px-6 py-4 bg-gray-100 rounded-2xl text-xl font-medium focus:ring-4 focus:ring-blue-300"
              >
                <option>None</option>
                <option>Run</option>
                <option>Cycle</option>
                <option>Swim</option>
              </select>
            </div>
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-6">
                <div className="text-5xl">üéæ</div>
                <span className="text-2xl font-semibold">Tennis</span>
              </div>
              <Toggle value={activity.tennis} onChange={v=>setActivity({...activity,tennis:v})} />
            </div>
          </div>

          <div className="bg-white rounded-3xl shadow-lg p-10 space-y-12">
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-6">
                <div className="text-5xl">üè•</div>
                <span className="text-2xl font-semibold">Rehab</span>
              </div>
              <Toggle value={activity.rehab} onChange={v=>setActivity({...activity,rehab:v})} />
            </div>
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-6">
                <div className="text-5xl">üßò</div>
                <span className="text-2xl font-semibold">Stretch</span>
              </div>
              <Toggle value={activity.stretch} onChange={v=>setActivity({...activity,stretch:v})} />
            </div>
          </div>
        </div>
      </div>

      {/* Submit Button */}
      <div className="fixed bottom-8 left-6 right-6">
        <button 
          disabled={!hasData} 
          onClick={handleSubmit}
          className={`w-full py-6 rounded-3xl font-bold text-2xl shadow-2xl transition transform active:scale-95 ${
            hasData 
              ? "bg-gradient-to-r from-blue-600 to-indigo-700 text-white" 
              : "bg-gray-300 text-gray-500"
          }`}
        >
          Complete Day
        </button>
      </div>
    </div>
  );
};

// --- STATS PAGE (include your previous version here) ---
// For brevity, assuming you have it ‚Äî add the Eating Out vs Home card as before

// --- APP ---
const App = () => {
  const [page, setPage] = useState('welcome');
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);

  const fetchLogs = async () => {
    setLoading(true);
    const { data } = await supabase.from("daily_logs").select("*").eq("user_id", "me").order("log_date", { ascending: false });
    setLogs(data || []);
    setLoading(false);
  };

  useEffect(() => { fetchLogs(); }, []);

  if (loading) return <div className="h-screen flex items-center justify-center text-3xl font-medium">Loading...</div>;

  return (
    <>
      {page === 'welcome' && <WelcomePage logs={logs} setPage={setPage} />}
      {page === 'log' && <LogPage logs={logs} setPage={setPage} refetchLogs={fetchLogs} />}
      {/* {page === 'stats' && <StatsPage logs={logs} setPage={setPage} />} */}
    </>
  );
};

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
