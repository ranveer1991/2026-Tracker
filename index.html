<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Habit Tracker</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Chart.js v3 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
</head>
<body class="bg-gray-50 font-sans antialiased">

<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef } = React;

// --- SUPABASE ---
const SUPABASE_URL = "https://lsctlfavvxasbkcvbjmq.supabase.co";
const SUPABASE_KEY = "sb_publishable_33maxbMOQrHvDSYwFouYNQ_EWrP1s8K";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// --- DATA ---
const breakfastOptions = ["", "Eggs ++", "Muesli + Milk", "Protein Shake", "Others"];
const lunchDinnerOptions = ["", "Indian", "Thai", "Mexican", "Soup / Noodles", "Bengali", "Italian", "Others"];

const defaultMeals = {
  breakfast: { activeChoice: false, cuisine: "", portion: false, avoidedDessert: true },
  lunch:     { activeChoice: false, cuisine: "", portion: false, avoidedDessert: true },
  dinner:    { activeChoice: false, cuisine: "", portion: false, avoidedDessert: true }
};
const defaultActivity = { 
  cardio: "none", 
  tennis: false, 
  strengthHome: false,
  strengthGym: false,
  rehab: false,
  mobility: false
};
const defaultDay = { avoidedSnack: true };

// --- TOGGLE COMPONENT ---
const Toggle = ({ value, onChange }) => (
  <button onClick={() => onChange(!value)} className="relative inline-flex items-center">
    <div className={`w-9 h-5 rounded-full transition duration-200 ${value ? "bg-blue-600" : "bg-gray-300"}`}>
      <div className={`w-4 h-4 bg-white rounded-full shadow absolute top-0.5 transition duration-200 ${value ? "translate-x-4" : "translate-x-0.5"}`} />
    </div>
  </button>
);

// --- MEAL CARD ---
const MealCard = ({ label, icon, data, onChange, options }) => (
  <div className="bg-white rounded-xl shadow-sm overflow-hidden">
    <div className="bg-gradient-to-r from-blue-50 to-indigo-50 px-4 py-4 text-center">
      <div className="text-3xl mb-1">{icon}</div>
      <h3 className="text-lg font-medium text-gray-800">{label}</h3>
    </div>

    <div className="p-4 space-y-3">
      <div className="flex justify-between items-center">
        <span className="text-sm font-medium text-gray-700">Active Choice</span>
        <Toggle value={data.activeChoice} onChange={v => onChange("activeChoice", v)} />
      </div>

      <select 
        value={data.cuisine} 
        onChange={e => onChange("cuisine", e.target.value)}
        className="w-full px-3 py-2 bg-gray-100 rounded text-sm font-medium text-gray-800 focus:outline-none focus:ring-1 focus:ring-blue-300"
      >
        {options.map(opt => <option key={opt} value={opt}>{opt || "‚Äî"}</option>)}
      </select>

      <div className="flex justify-between items-center">
        <span className="text-sm font-medium text-gray-700">Portion Controlled</span>
        <Toggle value={data.portion} onChange={v => onChange("portion", v)} />
      </div>

      <div className="flex justify-between items-center">
        <span className="text-sm font-medium text-gray-700">Avoided Dessert</span>
        <Toggle value={data.avoidedDessert} onChange={v => onChange("avoidedDessert", v)} />
      </div>
    </div>
  </div>
);

// --- WELCOME PAGE ---
const WelcomePage = ({ logs, setPage }) => {
  const today = new Date();
  const thirtyDaysAgo = new Date(today);
  thirtyDaysAgo.setDate(today.getDate() - 30);

  const loggedSet = new Set(logs.filter(log => new Date(log.log_date) >= thirtyDaysAgo).map(log => log.log_date));

  let streak = 0;
  let checkDate = new Date(today);
  while (true) {
    const dateStr = checkDate.toISOString().split('T')[0];
    if (loggedSet.has(dateStr)) {
      streak++;
      checkDate.setDate(checkDate.getDate() - 1);
    } else break;
  }

  return (
    <button 
      onClick={() => setPage('log')} 
      className="h-screen w-full flex items-center justify-center bg-gradient-to-br from-blue-50 to-purple-50 focus:outline-none"
    >
      <div className="text-center px-6">
        <h1 className="text-3xl font-bold text-gray-900 mb-8">Daily Habit Tracker</h1>
        <div className="bg-white rounded-xl shadow-md p-8 max-w-xs mx-auto">
          <h3 className="text-lg font-medium text-gray-700 mb-3">Current Streak</h3>
          <div className="text-5xl font-bold text-blue-600 mb-1">{streak}</div>
          <div className="text-base text-gray-600">days in a row üî•</div>
        </div>
        <p className="text-base text-gray-600 mt-8">Tap to log today</p>
      </div>
    </button>
  );
};

// --- LOG PAGE ---
const LogPage = ({ logs, setPage, refetchLogs }) => {
  const [meals, setMeals] = useState(defaultMeals);
  const [activity, setActivity] = useState(defaultActivity);
  const [avoidedSnack, setAvoidedSnack] = useState(true);

  const today = new Date().toISOString().split("T")[0];
  const todayLog = logs.find(l => l.log_date === today);

  useEffect(() => {
    if (todayLog) {
      setMeals(todayLog.meals || defaultMeals);
      setActivity(todayLog.activity || defaultActivity);
      setAvoidedSnack(todayLog.avoidedSnack ?? true);
    } else {
      setMeals(defaultMeals);
      setActivity(defaultActivity);
      setAvoidedSnack(true);
    }
  }, [todayLog]);

  const updateMeal = (meal, field, value) => {
    setMeals(prev => ({...prev, [meal]: {...prev[meal], [field]: value}}));
  };

  const hasData = Object.values(meals).some(m => m.activeChoice || m.cuisine || m.portion || !m.avoidedDessert) ||
                  activity.cardio !== "none" || activity.tennis || activity.strengthHome || activity.strengthGym ||
                  activity.rehab || activity.mobility || !avoidedSnack;

  const handleSubmit = async () => {
    const payload = { user_id: "me", log_date: today, meals, activity, avoidedSnack };
    const { error } = await supabase.from("daily_logs").upsert(payload, { onConflict: "user_id,log_date" });
    if (error) alert("Error: " + error.message);
    else {
      alert("‚úÖ Day logged!");
      refetchLogs();
      setPage('stats');
    }
  };

  const dateStr = new Date().toLocaleDateString(undefined, { weekday: "short", month: "short", day: "numeric" });

  return (
    <div className="min-h-screen pb-24">
      <div className="px-5 pt-8 pb-4 text-center">
        <h1 className="text-2xl font-bold text-gray-900">Today</h1>
        <p className="text-base text-gray-600 mt-1">{dateStr}</p>
      </div>

      <div className="px-5">
        <h2 className="text-lg font-semibold text-gray-800 mb-4 text-center">Meals</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-5 mb-8">
          <MealCard label="Breakfast" icon="üç≥" data={meals.breakfast} onChange={(f,v) => updateMeal("breakfast",f,v)} options={breakfastOptions} />
          <MealCard label="Lunch" icon="ü•ó" data={meals.lunch} onChange={(f,v) => updateMeal("lunch",f,v)} options={lunchDinnerOptions} />
          <MealCard label="Dinner" icon="üçΩÔ∏è" data={meals.dinner} onChange={(f,v) => updateMeal("dinner",f,v)} options={lunchDinnerOptions} />
        </div>

        <div className="bg-white rounded-xl shadow-sm p-4 mb-8">
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-3">
              <div className="text-3xl">üçø</div>
              <h3 className="text-base font-medium text-gray-800">Avoided a Snack</h3>
            </div>
            <Toggle value={avoidedSnack} onChange={setAvoidedSnack} />
          </div>
        </div>

        <h2 className="text-lg font-semibold text-gray-800 mb-4 text-center">Activity</h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-5 max-w-4xl mx-auto">
          <div className="bg-white rounded-xl shadow-sm p-4 space-y-4">
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <div className="text-3xl">üèÉ</div>
                <span className="text-base font-medium">Cardio</span>
              </div>
              <select value={activity.cardio} onChange={e=>setActivity({...activity,cardio:e.target.value})}
                className="px-3 py-1.5 bg-gray-100 rounded text-sm font-medium focus:ring-1 focus:ring-blue-300">
                <option>None</option>
                <option>Run</option>
                <option>Cycle</option>
                <option>Swim</option>
              </select>
            </div>
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <div className="text-3xl">üéæ</div>
                <span className="text-base font-medium">Tennis</span>
              </div>
              <Toggle value={activity.tennis} onChange={v=>setActivity({...activity,tennis:v})} />
            </div>
          </div>

          <div className="bg-white rounded-xl shadow-sm p-4 space-y-4">
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <div className="text-3xl">üèãÔ∏è</div>
                <span className="text-base font-medium">Strength (Home)</span>
              </div>
              <Toggle value={activity.strengthHome} onChange={v=>setActivity({...activity,strengthHome:v})} />
            </div>
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <div className="text-3xl">üí™</div>
                <span className="text-base font-medium">Strength (Gym)</span>
              </div>
              <Toggle value={activity.strengthGym} onChange={v=>setActivity({...activity,strengthGym:v})} />
            </div>
          </div>

          <div className="bg-white rounded-xl shadow-sm p-4 space-y-4">
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <div className="text-3xl">ü©π</div>
                <span className="text-base font-medium">Rehab</span>
              </div>
              <Toggle value={activity.rehab} onChange={v=>setActivity({...activity,rehab:v})} />
            </div>
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <div className="text-3xl">ü§∏</div>
                <span className="text-base font-medium">Mobility Routine</span>
              </div>
              <Toggle value={activity.mobility} onChange={v=>setActivity({...activity,mobility:v})} />
            </div>
          </div>
        </div>
      </div>

      <div className="fixed bottom-4 left-4 right-4">
        <button disabled={!hasData} onClick={handleSubmit}
          className={`w-full py-3 rounded-xl font-medium text-base shadow transition ${hasData ? "bg-blue-600 text-white" : "bg-gray-300 text-gray-500"}`}>
          Complete Day
        </button>
      </div>
    </div>
  );
};

// --- STATS PAGE FIXED ---
const StatsPage = ({ logs, setPage }) => {
  const [selectedPoint, setSelectedPoint] = useState(null);

  const lineCanvasRef = useRef(null);
  const breakfastRef = useRef(null);
  const lunchRef = useRef(null);
  const dinnerRef = useRef(null);

  const today = new Date();
  const thirtyDaysAgo = new Date(today);
  thirtyDaysAgo.setDate(today.getDate() - 30);

  const last30Logs = logs
    .filter(log => new Date(log.log_date) >= thirtyDaysAgo)
    .sort((a, b) => a.log_date.localeCompare(b.log_date));

  const dates = [];
  let current = new Date(thirtyDaysAgo);
  while (current <= today) {
    dates.push(current.toISOString().split('T')[0]);
    current.setDate(current.getDate() + 1);
  }

  const getCount = (date, field) => {
    const log = last30Logs.find(l => l.log_date === date);
    if (!log) return 0;
    return ['breakfast', 'lunch', 'dinner'].reduce((sum, meal) => sum + (log.meals[meal][field] ? 1 : 0), 0);
  };

  const activeChoiceData = dates.map(d => getCount(d, 'activeChoice'));
  const portionData = dates.map(d => getCount(d, 'portion'));
  const avoidedDessertData = dates.map(d => getCount(d, 'avoidedDessert'));

  // Streaks
  const calculateStreak = (conditionFn) => {
    let streak = 0;
    for (let i = last30Logs.length - 1; i >= 0; i--) {
      if (conditionFn(last30Logs[i])) streak++;
      else break;
    }
    return streak;
  };

  const loggingStreak = last30Logs.length;
  const mobilityStreak = calculateStreak(log => log.activity?.mobility);
  const noDessertStreak = calculateStreak(log => 
    log.meals.breakfast.avoidedDessert && 
    log.meals.lunch.avoidedDessert && 
    log.meals.dinner.avoidedDessert
  );
  const noSnackStreak = calculateStreak(log => log.avoidedSnack);

  // Activity totals
  const cardioSessions = last30Logs.filter(log => log.activity?.cardio !== "none").length;
  const tennisSessions = last30Logs.filter(log => log.activity?.tennis).length;
  const strengthSessions = last30Logs.filter(log => log.activity?.strengthHome || log.activity?.strengthGym).length;

  // Line Chart
  useEffect(() => {
    if (!lineCanvasRef.current) return;
    const ctx = lineCanvasRef.current.getContext('2d');
    let chart = lineCanvasRef.current.chartInstance;
    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dates.map(d => new Date(d).getDate()),
        datasets: [
          { label: 'Active Choices', data: activeChoiceData, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', tension: 0.3, pointRadius: 4 },
          { label: 'Portion Controlled', data: portionData, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', tension: 0.3, pointRadius: 4 },
          { label: 'Avoided Dessert', data: avoidedDessertData, borderColor: '#a855f7', backgroundColor: 'rgba(168,85,247,0.1)', tension: 0.3, pointRadius: 4 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'top' } },
        scales: { y: { min: 0, max: 3, ticks: { stepSize: 1 } } },
        onClick: (e, elements) => {
          if (elements.length > 0) {
            const index = elements[0].index;
            const date = dates[index];
            const day = new Date(date).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
            setSelectedPoint({ date: day, active: activeChoiceData[index], portion: portionData[index], dessert: avoidedDessertData[index] });
          }
        }
      }
    });
    lineCanvasRef.current.chartInstance = chart;
  }, [last30Logs]);

  // Stacked Charts
  const createStackedChart = (meal, ref) => {
    useEffect(() => {
      if (!ref.current) return;
      const ctx = ref.current.getContext('2d');
      let chart = ref.current.chartInstance;
      if (chart) chart.destroy();

      const cuisineCounts = {};
      last30Logs.forEach(log => {
        const cuisine = log.meals[meal].cuisine || "None";
        cuisineCounts[cuisine] = (cuisineCounts[cuisine] || 0) + 1;
      });
      const topCuisines = Object.keys(cuisineCounts).sort((a,b) => cuisineCounts[b] - cuisineCounts[a]).slice(0, 6);
      const colors = topCuisines.map((_, i) => `hsl(${i * 60}, 70%, 60%)`);

      const data = {
        labels: dates.map(d => new Date(d).getDate()),
        datasets: topCuisines.map((c, i) => ({
          label: c,
          data: dates.map(date => {
            const log = last30Logs.find(l => l.log_date === date);
            return log && log.meals[meal].cuisine === c ? 1 : 0;
          }),
          backgroundColor: colors[i]
        }))
      };

      chart = new Chart(ctx, {
        type: 'bar',
        data,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { x: { stacked: true }, y: { stacked: true, min: 0, max: 1, ticks: { stepSize: 1 } } }
        }
      });
      ref.current.chartInstance = chart;
    }, [last30Logs]);
  };

  useEffect(() => {
    createStackedChart('breakfast', breakfastRef);
    createStackedChart('lunch', lunchRef);
    createStackedChart('dinner', dinnerRef);
  }, [last30Logs]);

  return (
    <div className="min-h-screen pb-24">
      <div className="px-5 pt-8 pb-6 flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-900">Your Stats</h1>
        <button onClick={() => setPage('log')} className="text-blue-600 text-base font-medium">‚Üê Today</button>
      </div>

      <div className="px-5 space-y-8">
        <div className="bg-white rounded-2xl shadow-md p-6">
          <h2 className="text-xl font-bold text-gray-800 mb-5">Overall Streaks</h2>
          <div className="grid grid-cols-2 gap-4">
            <div className="text-center">
              <div className="text-3xl font-bold text-blue-600">{loggingStreak}</div>
              <p className="text-sm text-gray-600 mt-1">Logging</p>
            </div>
            <div className="text-center">
              <div className="text-3xl font-bold text-teal-600">{mobilityStreak}</div>
              <p className="text-sm text-gray-600 mt-1">Mobility</p>
            </div>
            <div className="text-center">
              <div className="text-3xl font-bold text-purple-600">{noDessertStreak}</div>
              <p className="text-sm text-gray-600 mt-1">No Dessert</p>
            </div>
            <div className="text-center">
              <div className="text-3xl font-bold text-orange-600">{noSnackStreak}</div>
              <p className="text-sm text-gray-600 mt-1">No Snack</p>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-2xl shadow-md p-6">
          <h2 className="text-xl font-bold text-gray-800 mb-5">Activity (Last 30 Days)</h2>
          <div className="space-y-4">
            <div className="flex justify-between">
              <span className="text-base font-medium">Cardio Sessions</span>
              <span className="text-2xl font-bold text-indigo-600">{cardioSessions}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-base font-medium">Tennis Sessions</span>
              <span className="text-2xl font-bold text-green-600">{tennisSessions}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-base font-medium">Strength Sessions</span>
              <span className="text-2xl font-bold text-purple-600">{strengthSessions}</span>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-2xl shadow-md p-6">
          <h2 className="text-xl font-bold text-gray-800 mb-5">Meal Habits Trend</h2>
          <div className="h-64 relative">
            <canvas ref={lineCanvasRef}></canvas>
          </div>
          {selectedPoint && (
            <div className="mt-4 p-4 bg-blue-50 rounded-lg text-center">
              <p className="text-sm font-medium text-gray-600">On {selectedPoint.date}:</p>
              <p className="text-base font-bold mt-1">
                Active: {selectedPoint.active} ¬∑ Portion: {selectedPoint.portion} ¬∑ Avoided Dessert: {selectedPoint.dessert}
              </p>
            </div>
          )}
        </div>

        <div className="space-y-6">
          <h2 className="text-xl font-bold text-gray-800">Cuisine by Meal</h2>
          <div className="bg-white rounded-2xl shadow-md p-6">
            <h3 className="text-base font-semibold mb-4">Breakfast</h3>
            <div className="h-48"><canvas ref={breakfastRef}></canvas></div>
          </div>
          <div className="bg-white rounded-2xl shadow-md p-6">
            <h3 className="text-base font-semibold mb-4">Lunch</h3>
            <div className="h-48"><canvas ref={lunchRef}></canvas></div>
          </div>
          <div className="bg-white rounded-2xl shadow-md p-6">
            <h3 className="text-base font-semibold mb-4">Dinner</h3>
            <div className="h-48"><canvas ref={dinnerRef}></canvas></div>
          </div>
        </div>
      </div>
    </div>
  );
};

// --- MAIN APP ---
const App = () => {
  const [page, setPage] = useState('welcome');
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(true);

  const fetchLogs = async () => {
    setLoading(true);
    const { data, error } = await supabase
      .from("daily_logs")
      .select("*")
      .eq("user_id", "me")
      .order("log_date", { ascending: false });

    if (!error && data) {
      setLogs(data);
    }
    setLoading(false);
  };

  useEffect(() => {
    fetchLogs();
  }, []);

  if (loading) {
    return <div className="flex items-center justify-center h-screen text-base">Loading...</div>;
  }

  return (
    <>
      {page === 'welcome' && <WelcomePage logs={logs} setPage={setPage} />}
      {page === 'log' && <LogPage logs={logs} setPage={setPage} refetchLogs={fetchLogs} />}
      {page === 'stats' && <StatsPage logs={logs} setPage={setPage} />}
    </>
  );
};

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
